events {
    worker_connections 1024;
}

http {
    # Redirection HTTP vers HTTPS pour tous les domaines
    server {
        listen 80;
        server_name marc.trapuce.tech back.marc.trapuce.tech keycloak.marc.trapuce.tech 
                   grafana.marc.trapuce.tech pgadmin.marc.trapuce.tech minio.marc.trapuce.tech 
                   minio-console.marc.trapuce.tech prometheus.marc.trapuce.tech;
        return 301 https://$server_name$request_uri;
    }

    # Configuration SSL commune
    ssl_certificate /etc/letsencrypt/live/marc.trapuce.tech/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/marc.trapuce.tech/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Serveur principal - marc.trapuce.tech
    server {
        listen 443 ssl http2;
        server_name marc.trapuce.tech;

        location / {
            proxy_pass http://front/;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api {
            proxy_pass http://backend:8082/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Backend direct
    server {
        listen 443 ssl http2;
        server_name back.marc.trapuce.tech;

        location / {
            proxy_pass http://backend:8082/;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Keycloak
    server {
        listen 443 ssl http2;
        server_name keycloak.marc.trapuce.tech;

        location / {
            proxy_pass http://keycloak:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
            # ðŸ”§ Ces deux lignes sont ESSENTIELLES :
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Port 443;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # PgAdmin
    server {
        listen 443 ssl http2;
        server_name pgadmin.marc.trapuce.tech;

        location / {
            proxy_pass http://pgadmin:80;
            proxy_set_header X-Script-Name /pgadmin;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # MinIO API
    server {
        listen 443 ssl http2;
        server_name minio.marc.trapuce.tech;

        location / {
            proxy_pass http://minio:9000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Script-Name /minio;
            proxy_redirect / /minio/;
        }
    }

    # MinIO Console
    server {
        listen 443 ssl http2;
        server_name minio-console.marc.trapuce.tech;

        location / {
            proxy_pass http://minio:8900/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Script-Name /minio-console;
            proxy_redirect / /;
            sub_filter 'href="/' 'href="/';
            sub_filter 'src="/' 'src="/';
            sub_filter_once off;
        }
    }

    # Grafana
    server {
        listen 443 ssl http2;
        server_name grafana.marc.trapuce.tech;

        location / {
            proxy_pass http://grafana:3000;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $http_host;
        }
    }

    # Prometheus
    server {
        listen 443 ssl http2;
        server_name prometheus.marc.trapuce.tech;

        location / {
            proxy_pass http://prometheus:9090/;
            proxy_set_header X-Script-Name /prometheus;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}