events{}

http {
    # Configuration principale pour marc.trapuce.tech
    server{
        listen 80;
        server_name marc.trapuce.tech;

        # Application principale (frontend)
        location / {
            proxy_pass http://front-prod/;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }     
        
        # API Backend
        location /api {
            proxy_pass http://backend-prod:8082/api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # PgAdmin
    server{
        listen 80;
        server_name pgadmin.marc.trapuce.tech;
        
        location / {
            proxy_pass http://pgadmin-prod:80;
            proxy_set_header X-Script-Name /pgadmin;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Keycloak
    server{
        listen 80;
        server_name keycloak.marc.trapuce.tech;
        
        location / {
            proxy_pass http://keycloak-prod:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
    }

    # MinIO API
    server{
        listen 80;
        server_name minio.marc.trapuce.tech;

        location / {
            proxy_pass http://minio-prod:9000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Script-Name /minio;
            proxy_redirect / /minio/;
        }
    }

    # MinIO Console
    server{
        listen 80;
        server_name minio-console.marc.trapuce.tech;

        location / {
            proxy_pass http://minio-prod:8900/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Script-Name /minio-console;
            proxy_redirect / /;
            # Correction des liens internes
            sub_filter 'href="/' 'href="/';
            sub_filter 'src="/' 'src="/';
            sub_filter_once off;
        }
    }

    # Grafana
    server{
        listen 80;
        server_name grafana.marc.trapuce.tech;

        location / {
            proxy_pass http://grafana-prod:3000;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $http_host;
        }
    }

    # Prometheus
    server{
        listen 80;
        server_name prometheus.marc.trapuce.tech;

        location / {
            proxy_pass http://prometheus-prod:9090/;
            proxy_set_header X-Script-Name /prometheus;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Backend direct (optionnel)
    server{
        listen 80;
        server_name backend.marc.trapuce.tech;

        location / {
            proxy_pass http://backend-prod:8082/;
            proxy_set_header X-Script-Name /backend;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
